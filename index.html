<html>

<head>
    <!-- Page config -->
    <meta charset="utf-8">
    <title>Mapas d3</title>

    <!-- Required libs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"
        integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"
        integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG"
        crossorigin="anonymous"></script>
    <script data-require="d3@4.0.0" data-semver="4.0.0" src="https://d3js.org/d3.v4.min.js"></script>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v3.min.js"></script>

    <!-- CSS styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Nabvar START -->
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" style="margin-left: 2%;" href="#">Mapas d3</a>
    </nav>
    <!-- Navbar END -->

    <h1 class="display-1" align="center">Mapa de canarias</h1>

    <!-- Map container -->
    <div id="map"></div>
    <svg></svg>

    <!-- Map script -->
    <script type="text/javascript">
        var width = 1000, height = 500, centered;

        var color = d3.scale.linear()
            .domain([10000, 100000])
            .clamp(true)
            .range(['#fff', '#409A99']);

        var projection = d3.geo.mercator()
            .scale([11000])
            .center([-15.749, 28.536])
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select('svg')
            .attr('width', width)
            .attr('height', height);

        svg.append('rect')
            .attr('class', 'background')
            .attr('width', width)
            .attr('height', height);
        //.on('click', clicked);

        var g = svg.append('g');

        var effectLayer = g.append('g')
            .classed('effect-layer', true);

        var mapLayer = g.append('g')
            .classed('map-layer', true);

        var mapLayer2 = g.append('g')
            .classed('map-layer', true);

        var dummyText = g.append('text')
            .classed('dummy-text', true)
            .attr('x', 10)
            .attr('y', 30)
            .style('opacity', 0);

        var bigText = g.append('text')
            .classed('big-text', true)
            .attr('x', 20)
            .attr('y', 45);

        // Poblation map
        d3.json('data/indicadores_poblacion_municipios.geojson', function (error, mapData) {
            var features = mapData.features;

            console.log(features[0]);
            //color.domain([0, d3.max(features, nameLength)]);

            mapLayer.selectAll('path')
                .data(features)
                .enter().append('path')
                .attr('d', path)
                .attr('vector-effect', 'non-scaling-stroke')
                .style('fill', fillFn)
                .on('mouseover', mouseover)
                .on('mouseout', mouseout)
                .on('click', clicked);
        });

        d3.json('data/grid250Canarias_poblacion.geojson', function (error, mapData) {
            var features = mapData.features;

            mapLayer2.selectAll('path')
                .data(features)
                .enter().append('path')
                .attr('d', path)
                /*.attr('vector-effect', 'non-scaling-stroke')
                .style('fill', "#FF0000")
                .on('mouseover', mouseover)
                .on('mouseout', mouseout)
                .on('click', clicked);*/
                ;
        });

        // Aditional functions
        function nameFn(d) {
            return d && d.properties ? d.properties.label : null;
        }
        
        function nameLength(d) {
            var n = nameFn(d);
            return n ? n.length : 0;
        }

        function fillFn(d) {
            return color(d.properties.indicadores_municipal_TOTAL);
        }

        function clicked(d) {
            var x, y, k;

            if (d && centered !== d) {
                var centroid = path.centroid(d);
                x = centroid[0];
                y = centroid[1];
                k = 4;
                centered = d;
            } else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }

            mapLayer.selectAll('path')
                .style('fill', function (d) { return centered && d === centered ? '#D5708B' : fillFn(d); });

            g.transition()
                .duration(750)
                .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')');
        }

        function mouseover(d) {
            d3.select(this).style('fill', 'orange');

            textArt(nameFn(d));
        }

        function mouseout(d) {
            mapLayer.selectAll('path')
                .style('fill', function (d) { return centered && d === centered ? '#D5708B' : fillFn(d); });

            effectLayer.selectAll('text').transition()
                .style('opacity', 0)
                .remove();

            bigText.text('');
        }

        var BASE_FONT = "'Helvetica Neue', Helvetica, Arial, sans-serif";

        var FONTS = [
            "Open Sans",
            "Josefin Slab",
            "Arvo",
            "Lato",
            "Vollkorn",
            "Abril Fatface",
            "Old StandardTT",
            "Droid+Sans",
            "Lobster",
            "Inconsolata",
            "Montserrat",
            "Playfair Display",
            "Karla",
            "Alegreya",
            "Libre Baskerville",
            "Merriweather",
            "Lora",
            "Archivo Narrow",
            "Neuton",
            "Signika",
            "Questrial",
            "Fjalla One",
            "Bitter",
            "Varela Round"
        ];

        function textArt(text) {
            // Use random font
            var fontIndex = Math.round(Math.random() * FONTS.length);
            var fontFamily = FONTS[fontIndex] + ', ' + BASE_FONT;

            bigText
                .style('font-family', fontFamily)
                .text(text);

            // Use dummy text to compute actual width of the text
            // getBBox() will return bounding box
            dummyText
                .style('font-family', fontFamily)
                .text(text);
            var bbox = dummyText.node().getBBox();

            var textWidth = bbox.width;
            var textHeight = bbox.height;
            var xGap = 3;
            var yGap = 1;

            var selection = effectLayer.selectAll('text')
                .data(positions, function (d) { return d.text + '/' + d.index; });

            // Clear old ones
            selection.exit().transition()
                .style('opacity', 0)
                .remove();

            // Create text but set opacity to 0
            selection.enter().append('text')
                .text(function (d) { return d.text; })
                .attr('x', function (d) { return d.x; })
                .attr('y', function (d) { return d.y; })
                .style('font-family', fontFamily)
                .style('fill', '#777')
                .style('opacity', 0);

            selection
                .style('font-family', fontFamily)
                .attr('x', function (d) { return d.x; })
                .attr('y', function (d) { return d.y; });

            // Create transtion to increase opacity from 0 to 0.1-0.5
            // Add delay based on distance from the center of the <svg> and a bit more randomness.
            selection.transition()
                .delay(function (d) {
                    return d.distance * 0.01 + Math.random() * 1000;
                })
                .style('opacity', function (d) {
                    return 0.1 + Math.random() * 0.4;
                });
        }

    </script>
</body>

</html>