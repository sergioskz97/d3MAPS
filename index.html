<html>

<head>
    <!-- Page config -->
    <meta charset="utf-8">
    <title>Generación de mapas d3</title>
    <link rel="icon" type="image/png" href="./assets/logo.png" />

    <!-- Required libs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"
        integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"
        integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG"
        crossorigin="anonymous"></script>
    <script data-require="d3@4.0.0" data-semver="4.0.0" src="https://d3js.org/d3.v4.min.js"></script>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v3.min.js"></script>

    <!-- CSS styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Nabvar START -->
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="https://d3js.org/" style="margin-left: 5%;">
            <img src="./assets/logo.png" width="30" height="30" alt="D3js logo" style="margin-left: 20%;">
            Generación de mapas en D3
        </a>
    </nav>
    <!-- Navbar END -->

    <!-- Content -->
    <div class="container">
        <h1 class="display-4">Granularidad de Canarias</h1>

        <p>
            Es bien conocido que uno de los mitos sobre la población de canarias siempre ha sido que cuentan con un gran
            número de población femenina, siendo así que una de las frases más repetidas por la población ajena a las
            islas es “Teneis 5 mujeres por cada hombre” y ¿Es esto cierto? Vamos a comprobarlo.

            <br><br>

            Si bien es cierto que hace relativamente pocos años la población si era mayoritariamente de género femenino
            esta estaba lejos de cumplir con la frase anteriormente mencionada pues la relación era 70-30 en favor de
            las mujeres.

            <br><br>

            Dicho esto, ¿Qué ocurre en la actualidad? Pues si observamos los datos de los últimos años hasta la
            actualidad podemos observar como es estadística se ha ido compensando llegando hasta la situación actual,
            donde mediante el mapa generado podemos observar que en la mayoría de casos el número de hombres y mujeres
            es muy similar, por lo cual el mito que se ha generado entorno a la población canaria podemos determinar que
            es totalmente falso.

            <br><br>

            El presente gráfico muestra la granularidad de población en Canarias
        </p>

        <br>
        <!-- Map container -->
        <svg></svg>

        <br style="margin-bottom: 5%;">
    </div>
    <!-- Content END -->

    <!-- Map script -->
    <script type="text/javascript">

        ///////////////////
        // Map Functions //
        ///////////////////
        var width = 1000, height = 500, centered;

        var color = d3.scale.linear()
            .domain([10000, 100000])
            .clamp(true)
            .range(['#fff', '#409A99']);

        var projection = d3.geo.mercator()
            .scale([11000])
            .center([-15.749, 28.536])
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var path2 = d3.geo.path()
            .projection(projection);

        var svg = d3.select('svg')
            .attr('width', width)
            .attr('height', height);

        svg.append('rect')
            .attr('class', 'background')
            .attr('width', width)
            .attr('height', height);
        //.on('click', clicked);

        var g = svg.append('g');

        var effectLayer = g.append('g')
            .classed('effect-layer', true);

        var mapLayer = g.append('g')
            .classed('map-layer', true);

        var mapLayer2 = g.append('g');

        var dummyText = g.append('text')
            .classed('dummy-text', true)
            .attr('x', 10)
            .attr('y', 30)
            .style('opacity', 0);

        var bigText = g.append('text')
            .classed('big-text', true)
            .attr('x', 20)
            .attr('y', 45);

        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Poblation map
        d3.json('data/indicadores_poblacion_municipios.geojson', function (error, mapData) {
            var features = mapData.features;

            console.log(features[0]);

            mapLayer.selectAll('path')
                .data(features)
                .enter().append('path')
                .attr('d', path)
                .attr('vector-effect', 'non-scaling-stroke')
                .style('fill', fillFn)
                .on('mouseover', mouseover)
                .on('mouseout', mouseout)
                .on('click', clicked);
        });

        // Granularity map
        d3.json('data/grid250Canarias_poblacion.geojson', function (error, mapData) {
            var features = mapData.features;

            mapLayer2.selectAll('path')
                .data(features)
                .enter().append('path')
                .attr('d', path2)
                .attr('vector-effect', 'non-scaling-stroke')
                .style('fill', "#FF0000")
                .on('mouseover', tooltipOver)
                .on('mouseout', tooltipOut)
                .on('click', tooltipClick);
        });

        /////////////////////////
        // Aditional functions //
        /////////////////////////

        /**
         * 
        */
        function nameFn(d) {
            return d && d.properties ? d.properties.label : null;
        }

        /**
         * 
        */
        function nameLength(d) {
            var n = nameFn(d);
            return n ? n.length : 0;
        }

        /**
         * 
        */
        function fillFn(d) {
            return color(d.properties.indicadores_municipal_TOTAL);
        }

        /**
         * 
        */
        function clicked(d) {
            var x, y, k;

            if (d && centered !== d) {
                var centroid = path.centroid(d);
                x = centroid[0];
                y = centroid[1];
                k = 4;
                centered = d;
            } else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }

            mapLayer.selectAll('path')
                .style('fill', function (d) { return centered && d === centered ? '#D5708B' : fillFn(d); });

            g.transition()
                .duration(750)
                .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')');
        }

        /**
         * 
        */
        function mouseover(d) {
            d3.select(this).style('fill', 'orange');

            textArt(nameFn(d));
        }

        /**
         * 
        */
        function mouseout(d) {
            mapLayer.selectAll('path')
                .style('fill', function (d) { return centered && d === centered ? '#D5708B' : fillFn(d); });

            effectLayer.selectAll('text').transition()
                .style('opacity', 0)
                .remove();

            bigText.text('');
        }

        var BASE_FONT = "'Helvetica Neue', Helvetica, Arial, sans-serif";

        /**
         * 
        */
        function textArt(text) {

            bigText
                .text(text);

            dummyText
                .text(text);

            var bbox = dummyText.node().getBBox();

            var textWidth = bbox.width;
            var textHeight = bbox.height;
            var xGap = 3;
            var yGap = 1;

            var selection = effectLayer.selectAll('text')
                .data(positions, function (d) { return d.text + '/' + d.index; });

            selection.exit().transition()
                .style('opacity', 0)
                .remove();

            selection.enter().append('text')
                .text(function (d) { return d.text; })
                .attr('x', function (d) { return d.x; })
                .attr('y', function (d) { return d.y; })
                .style('font-family', fontFamily)
                .style('fill', '#777')
                .style('opacity', 0);

            selection
                .style('font-family', fontFamily)
                .attr('x', function (d) { return d.x; })
                .attr('y', function (d) { return d.y; });

            selection.transition()
                .delay(function (d) {
                    return d.distance * 0.01 + Math.random() * 1000;
                })
                .style('opacity', function (d) {
                    return 0.1 + Math.random() * 0.4;
                });
        }

        /**
         * 
        */
        function tooltipOver(d) {
            div.transition()
                .duration(200)
                .style("opacity", .9);

            div.html("Hombres: " + d.properties["PMH_SD_20170101_Indicadores_Descarga ISB-ULL_Hombres"] + "<br/> Mujeres: " +
                d.properties["PMH_SD_20170101_Indicadores_Descarga ISB-ULL_Mujeres"])
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
        }

        /**
         * 
         */
        function tooltipOut(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);
        }

        /**
         * 
        */
        function tooltipClick(d) {
            console.log(d.properties.label);
            console.log(d.properties.indicadores_municipal_TOTAL)
        }

    </script>
</body>

</html>